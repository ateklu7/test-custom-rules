# I get the payload from a request like this : {"event":"deployment_protection_rule","payload":{"action":"requested","environment":"prod","event":"workflow_dispatch","deployment_callback_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/actions/runs/6357681153/deployment_protection_rule","deployment":{"url":"https://api.github.com/repos/maira-samtek/test-custom-rules/deployments/1098698603","id":1098698603,"node_id":"DE_kwDOKZ91yc5BfM9r","task":"deploy","original_environment":"prod","environment":"prod","description":null,"created_at":"2023-09-29T22:10:50Z","updated_at":"2023-09-29T22:10:52Z","statuses_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/deployments/1098698603/statuses","repository_url":"https://api.github.com/repos/maira-samtek/test-custom-rules","creator":{"login":"maira-samtek","id":120603218,"node_id":"U_kgDOBzBCUg","avatar_url":"https://avatars.githubusercontent.com/u/120603218?v=4","gravatar_id":"","url":"https://api.github.com/users/maira-samtek","html_url":"https://github.com/maira-samtek","followers_url":"https://api.github.com/users/maira-samtek/followers","following_url":"https://api.github.com/users/maira-samtek/following{/other_user}","gists_url":"https://api.github.com/users/maira-samtek/gists{/gist_id}","starred_url":"https://api.github.com/users/maira-samtek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maira-samtek/subscriptions","organizations_url":"https://api.github.com/users/maira-samtek/orgs","repos_url":"https://api.github.com/users/maira-samtek/repos","events_url":"https://api.github.com/users/maira-samtek/events{/privacy}","received_events_url":"https://api.github.com/users/maira-samtek/received_events","type":"User","site_admin":false},"sha":"5f3864fb12d427ab3bc4cc9689e55e3e645c5821","ref":"main","payload":{},"transient_environment":false,"production_environment":false,"performed_via_github_app":{"id":15368,"slug":"github-actions","node_id":"MDM6QXBwMTUzNjg=","owner":{"login":"github","id":9919,"node_id":"MDEyOk9yZ2FuaXphdGlvbjk5MTk=","avatar_url":"https://avatars.githubusercontent.com/u/9919?v=4","gravatar_id":"","url":"https://api.github.com/users/github","html_url":"https://github.com/github","followers_url":"https://api.github.com/users/github/followers","following_url":"https://api.github.com/users/github/following{/other_user}","gists_url":"https://api.github.com/users/github/gists{/gist_id}","starred_url":"https://api.github.com/users/github/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/github/subscriptions","organizations_url":"https://api.github.com/users/github/orgs","repos_url":"https://api.github.com/users/github/repos","events_url":"https://api.github.com/users/github/events{/privacy}","received_events_url":"https://api.github.com/users/github/received_events","type":"Organization","site_admin":false},"name":"GitHub Actions","description":"Automate your workflow from idea to production","external_url":"https://help.github.com/en/actions","html_url":"https://github.com/apps/github-actions","created_at":"2018-07-30T09:30:17Z","updated_at":"2019-12-10T19:04:12Z","permissions":{"actions":"write","administration":"read","checks":"write","contents":"write","deployments":"write","discussions":"write","issues":"write","merge_queues":"write","metadata":"read","packages":"write","pages":"write","pull_requests":"write","repository_hooks":"write","repository_projects":"write","security_events":"write","statuses":"write","vulnerability_alerts":"read"},"events":["branch_protection_rule","check_run","check_suite","create","delete","deployment","deployment_status","discussion","discussion_comment","fork","gollum","issues","issue_comment","label","merge_group","milestone","page_build","project","project_card","project_column","public","pull_request","pull_request_review","pull_request_review_comment","push","registry_package","release","repository","repository_dispatch","status","watch","workflow_dispatch","workflow_run"]}},"pull_requests":[],"repository":{"id":698316233,"node_id":"R_kgDOKZ91yQ","name":"test-custom-rules","full_name":"maira-samtek/test-custom-rules","private":false,"owner":{"login":"maira-samtek","id":120603218,"node_id":"U_kgDOBzBCUg","avatar_url":"https://avatars.githubusercontent.com/u/120603218?v=4","gravatar_id":"","url":"https://api.github.com/users/maira-samtek","html_url":"https://github.com/maira-samtek","followers_url":"https://api.github.com/users/maira-samtek/followers","following_url":"https://api.github.com/users/maira-samtek/following{/other_user}","gists_url":"https://api.github.com/users/maira-samtek/gists{/gist_id}","starred_url":"https://api.github.com/users/maira-samtek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maira-samtek/subscriptions","organizations_url":"https://api.github.com/users/maira-samtek/orgs","repos_url":"https://api.github.com/users/maira-samtek/repos","events_url":"https://api.github.com/users/maira-samtek/events{/privacy}","received_events_url":"https://api.github.com/users/maira-samtek/received_events","type":"User","site_admin":false},"html_url":"https://github.com/maira-samtek/test-custom-rules","description":null,"fork":false,"url":"https://api.github.com/repos/maira-samtek/test-custom-rules","forks_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/forks","keys_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/keys{/key_id}","collaborators_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/teams","hooks_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/hooks","issue_events_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/issues/events{/number}","events_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/events","assignees_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/assignees{/user}","branches_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/branches{/branch}","tags_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/tags","blobs_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/git/refs{/sha}","trees_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/git/trees{/sha}","statuses_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/statuses/{sha}","languages_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/languages","stargazers_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/stargazers","contributors_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/contributors","subscribers_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/subscribers","subscription_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/subscription","commits_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/commits{/sha}","git_commits_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/git/commits{/sha}","comments_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/comments{/number}","issue_comment_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/issues/comments{/number}","contents_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/contents/{+path}","compare_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/compare/{base}...{head}","merges_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/merges","archive_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/downloads","issues_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/issues{/number}","pulls_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/pulls{/number}","milestones_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/milestones{/number}","notifications_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/labels{/name}","releases_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/releases{/id}","deployments_url":"https://api.github.com/repos/maira-samtek/test-custom-rules/deployments","created_at":"2023-09-29T16:30:14Z","updated_at":"2023-09-29T16:30:15Z","pushed_at":"2023-09-29T22:09:23Z","git_url":"git://github.com/maira-samtek/test-custom-rules.git","ssh_url":"git@github.com:maira-samtek/test-custom-rules.git","clone_url":"https://github.com/maira-samtek/test-custom-rules.git","svn_url":"https://github.com/maira-samtek/test-custom-rules","homepage":null,"size":0,"stargazers_count":0,"watchers_count":0,"language":null,"has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":0,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":0,"license":null,"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":0,"open_issues":0,"watchers":0,"default_branch":"main"},"sender":{"login":"maira-samtek","id":120603218,"node_id":"U_kgDOBzBCUg","avatar_url":"https://avatars.githubusercontent.com/u/120603218?v=4","gravatar_id":"","url":"https://api.github.com/users/maira-samtek","html_url":"https://github.com/maira-samtek","followers_url":"https://api.github.com/users/maira-samtek/followers","following_url":"https://api.github.com/users/maira-samtek/following{/other_user}","gists_url":"https://api.github.com/users/maira-samtek/gists{/gist_id}","starred_url":"https://api.github.com/users/maira-samtek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maira-samtek/subscriptions","organizations_url":"https://api.github.com/users/maira-samtek/orgs","repos_url":"https://api.github.com/users/maira-samtek/repos","events_url":"https://api.github.com/users/maira-samtek/events{/privacy}","received_events_url":"https://api.github.com/users/maira-samtek/received_events","type":"User","site_admin":false},"installation":{"id":42358353,"node_id":"MDIzOkludGVncmF0aW9uSW5zdGFsbGF0aW9uNDIzNTgzNTM="}}}

# could you auto approve the custom_deployment rule for me?
import json
import requests
import jwt
import time



def getJWT():
    pem = 'custom-approver.2023-09-29.private-key.pem'
    app_id = 399239

    # Open PEM
    with open(pem, 'rb') as pem_file:
        signing_key = jwt.jwk_from_pem(pem_file.read())

    payload = {
        # Issued at time
        'iat': int(time.time()),
        # JWT expiration time (10 minutes maximum)
        'exp': int(time.time()) + 600,
        # GitHub App's identifier
        'iss': app_id
    }

    # Create JWT
    jwt_instance = jwt.JWT()
    encoded_jwt = jwt_instance.encode(payload, signing_key, alg='RS256')

    print(f"JWT:  {encoded_jwt}")
    return encoded_jwt


# get installation token
def get_token(installation_id, jwt):
    url = f'https://api.github.com/app/installations/{installation_id}/access_tokens'
    headers = {'Authorization': f'Bearer {jwt}'}
    response = requests.post(url, headers=headers)
    print(response.json()['token'])
    return response.json()['token']


def respond_deployment(deployment_callback_url, token, environment_name,  status):
    url = deployment_callback_url
    payload = json.dumps({
        "environment_name": environment_name,
        "state": status,
        "comment": "Reviewed"
    })

    headers = {
        'Accept': 'application/vnd.github.antiope-preview+json',
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json',
        'X-GitHub-Api-Version': '2022-11-28'
    }

    response = requests.request("POST", url, headers=headers, data=payload)
    print(response.text)
    return response.text


def process_payload(response):
    # get the deployment callback url
    payload = response['payload']
    deployment_callback_url = payload['deployment_callback_url']
    print(deployment_callback_url)
    # get the installation id
    print(payload['installation']['id'])
    installation_id = payload['installation']['id']
    print(installation_id)

    # get the JWT
    jwt = getJWT()
    token = get_token(installation_id, jwt)

    # get the environment name
    environment_name = payload['environment']
    print(environment_name)

    # get run info url after removing 'deployment_protection_rule' from the deployment_callback_url
    run_api = deployment_callback_url.replace('/deployment_protection_rule', '')
    print(run_api)

    # get the run info
    headers = {'Authorization': f'Bearer {token}'}

    response = requests.get(run_api, headers=headers)
    # get run name 
    run_name = response.json()['name']
    print(run_name)

    if run_name == "Sync Security Hub findings and Jira issues":
        print("Approving the deployment")
        respond_deployment(deployment_callback_url, token, environment_name, "approved")
    else:
        print("Rejecting the deployment")
        respond_deployment(deployment_callback_url, token, environment_name, "rejected")

    return f"Processed."


def respond_to_request(event, context):
    print(f"Received event: {event}")
    payload = json.loads(event['body'])
    print(payload)
    return process_payload(payload)

def handler(event, context):
  print('received event:')
  print(event)
  payload = json.loads(event['body'])
  print(payload)
  process_payload(payload)
  
  return {
      'statusCode': 200,
      'headers': {
          'Access-Control-Allow-Headers': '*',
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'OPTIONS,POST,GET'
      },
      'body': json.dumps('Hello from your new Amplify Python lambda!')
  }
